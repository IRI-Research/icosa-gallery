{{ asset.presentation_params|json_script:"presentation-params" }}
<script type="module">
    import {Viewer} from "/static/js/icosa-viewer.module.js?v={% now "U" %}";

    var viewer = new Viewer("https://icosa-foundation.github.io/icosa-sketch-assets/");

    let presentationParams = JSON.parse(document.getElementById('presentation-params').textContent);
    let overrides = {
        'defaultBackgroundColor': presentationParams?.backgroundColor || "#000000",
        'camera': presentationParams.camera,
        'geometryData': presentationParams.GOOGLE_geometry_data,
        'colorSpace': presentationParams.colorSpace,
    };

    // For debugging
    window.viewer = viewer;
    window.THREE = viewer.three;

    {% if not asset.has_tilt and not override_suffix and not format_override %}

        let url = "{{ asset.preferred_viewer_format.url }}".replace("_%28GLTFupdated%29", ""); // Remove suffix to avoid duplicating it
        url = "{{ asset.preferred_viewer_format.url }}".replace(".gltf", "_%28GLTFupdated%29.gltf"); // Add suffix
        let formatType = "gltf2";

    {% else %}

        {% if format_override %}
            let formatType = "{{ format_override }}".toLowerCase();
        {% else %}
            let formatType = "{{ asset.preferred_viewer_format.format }}".toLowerCase();
        {% endif %}

        {% if override_suffix %}
            let url = "{{ asset.preferred_viewer_format.url }}".replace("_%28GLTFupdated%29", "");
        {% else %}
            let url = "{{ asset.preferred_viewer_format.url }}";
        {% endif %}

    {% endif %}

    if (formatType === 'gltf2' || formatType === 'glb') {
        try {
            console.log("Trying to load as GLTF2");
            await viewer.loadGltf(url, true, overrides);
        } catch (error) {
            console.log(error);
            console.log("GLTF2 failed. Trying to load as GLTF1");
            await viewer.loadGltf1(url, true, overrides);
        }
    } else if (formatType === 'gltf') {
        try {
            console.log("Trying to load as GLTF1");
            await viewer.loadGltf1(url, true, overrides);
        } catch (error) {
            console.log(error);
            console.log("GLTF1 failed. Trying to load as GLTF2");
            await viewer.loadGltf(url, true, overrides);
        }
    } else if (formatType === 'obj') {
        console.log("Trying to load obj");
        let mtlUrl = "{{ asset.preferred_viewer_format.materialUrl }}";
        await viewer.loadObjWithMtl(url, mtlUrl, overrides);
    } else if (formatType === 'fbx') {
        console.log("Trying to load fbx");
        await viewer.loadFbx(url, overrides);
    } else {
        console.error("Unsupported file format: " + formatType);
    }


    // For debugging
    window.viewer = viewer;
    window.THREE = viewer.three;

</script>
